pipeline {
    agent any

    environment {
        DOCKERHUB_USER = 'venkatesh1432'
        AWS_REGION     = 'ap-south-1'
        ASG_NAME       = 'New-Fintech-AutoScaling'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Detect Changed Services') {
            steps {
                script {
                    env.FRONTEND_CHANGED = 'false'
                    env.AUTH_CHANGED     = 'false'
                    env.TX_CHANGED       = 'false'

                    if (!env.GIT_PREVIOUS_SUCCESSFUL_COMMIT) {
                        env.FRONTEND_CHANGED = 'true'
                        env.AUTH_CHANGED     = 'true'
                        env.TX_CHANGED       = 'true'
                    } else {
                        def files = sh(
                            script: "git diff --name-only ${env.GIT_PREVIOUS_SUCCESSFUL_COMMIT} ${env.GIT_COMMIT}",
                            returnStdout: true
                        ).trim().split("\\n")

                        files.each {
                            if (it.startsWith('frontend/')) env.FRONTEND_CHANGED = 'true'
                            if (it.startsWith('service/auth-service/')) env.AUTH_CHANGED = 'true'
                            if (it.startsWith('service/transaction-service/')) env.TX_CHANGED = 'true'
                        }
                    }
                }
            }
        }

        stage('Build & Push Images') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-creds') {

                        if (env.FRONTEND_CHANGED == 'true') {
                            docker.build("${DOCKERHUB_USER}/fintech-frontend:latest", "./frontend").push()
                        }

                        if (env.AUTH_CHANGED == 'true') {
                            docker.build("${DOCKERHUB_USER}/fintech-auth-service:latest", "./service/auth-service").push()
                        }

                        if (env.TX_CHANGED == 'true') {
                            docker.build("${DOCKERHUB_USER}/fintech-transaction-service:latest", "./service/transaction-service").push()
                        }
                    }
                }
            }
        }

        stage('ASG Instance Refresh') {
            steps {
                sh """
                  aws configure set region ${AWS_REGION}
                  aws autoscaling start-instance-refresh \
                    --auto-scaling-group-name ${ASG_NAME} \
                    --preferences MinHealthyPercentage=50,InstanceWarmup=300
                """
            }
        }
    }
}
