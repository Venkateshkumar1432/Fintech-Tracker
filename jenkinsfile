pipeline {
  agent any

  environment {
    DOCKERHUB_USER = 'venkatesh1432'
    APP_SERVERS = 'ubuntu@13.233.24.245 ubuntu@43.204.130.140 ubuntu@13.235.70.195'
  }

  stages {

    stage('Checkout Source Code') {
      steps {
        checkout scm
      }
    }

    stage('Build & Push Docker Images') {
      steps {
        script {
          docker.withRegistry(
            'https://index.docker.io/v1/',
            'dockerhub-creds'
          ) {

            echo "Building & pushing frontend image"
            docker.build(
              "${DOCKERHUB_USER}/fintech-frontend:latest",
              "frontend"
            ).push()

            echo "Building & pushing auth-service image"
            docker.build(
              "${DOCKERHUB_USER}/fintech-auth-service:latest",
              "service/auth-service"
            ).push()

            echo "Building & pushing transaction-service image"
            docker.build(
              "${DOCKERHUB_USER}/fintech-transaction-service:latest",
              "service/transaction-service"
            ).push()
          }
        }
      }
    }

    stage('Zero Downtime Deploy (Rolling)') {
      steps {
        sshagent(['ec2-ssh-key']) {
          script {
            def servers = env.APP_SERVERS.split()

            for (server in servers) {
              echo "Deploying to ${server}"

              sh """
              ssh -o StrictHostKeyChecking=no ${server} '
                cd /opt/fintech &&
                git fetch origin &&
                git reset --hard origin/main &&
                docker-compose -f docker-compose.prod.yml pull &&
                docker-compose -f docker-compose.prod.yml up -d
              '
              """

              echo "Waiting for containers to stabilize on ${server}"
              sleep 20
            }
          }
        }
      }
    }
  }

  post {
    success {
      echo "✅ Deployment completed successfully"
    }
    failure {
      echo "❌ Deployment failed"
    }
  }
}
